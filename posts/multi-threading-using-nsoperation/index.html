<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Multi-Threading using NSOperation" /><meta name="author" content="Zeeshan Khan" /><meta property="og:locale" content="en" /><meta name="description" content="Recently I had given couple of presentations on Multithreading using NSOperations and GCD. Here is the first draft of transcript." /><meta property="og:description" content="Recently I had given couple of presentations on Multithreading using NSOperations and GCD. Here is the first draft of transcript." /><link rel="canonical" href="https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/" /><meta property="og:url" content="https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/" /><meta property="og:site_name" content="zeeshan’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-08-17T00:00:00+04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Multi-Threading using NSOperation" /><meta name="twitter:site" content="@zeeshan_khan" /><meta name="twitter:creator" content="@Zeeshan Khan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeeshan Khan"},"dateModified":"2014-08-17T00:00:00+04:00","datePublished":"2014-08-17T00:00:00+04:00","description":"Recently I had given couple of presentations on Multithreading using NSOperations and GCD. Here is the first draft of transcript.","headline":"Multi-Threading using NSOperation","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/"},"url":"https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/"}</script><title>Multi-Threading using NSOperation | zeeshan's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zeeshan's blog"><meta name="application-name" content="zeeshan's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sample/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zeeshan's blog</a></div><div class="site-subtitle font-italic">Recording my learnings from  development</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/zeeshankhan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zeeshan_khan" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['izeeshankhan','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Multi-Threading using NSOperation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Multi-Threading using NSOperation</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1408219200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2014-08-17 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3534 words"> <em>19 min</em> read</span></div></div></div><div class="post-content"><p>Recently I had given couple of presentations on Multithreading using NSOperations and GCD. Here is the first draft of transcript.</p><h2 id="cpu-central-processing-unit"><span class="mr-2">CPU (Central Processing Unit)</span><a href="#cpu-central-processing-unit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>WHY I’m starting from here, because everything happens here only. But this is not the reason, The reason is to start from here is that how earlier days of computing works?Before going into the threads, lets go into initial days of computing, then we’ll try to solve some questions like:</p><ul><li>What do we understand by Cores like single core, dual core, octa core systems?<li>How does these came into existences?<li>What are the problem we faced before building this?<li>How does it effect our system?</ul><h2 id="clock-speed"><span class="mr-2">Clock Speed</span><a href="#clock-speed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The Clock Speed (of CPU) is used to determine the maximum amount of wok a computer (CPU) can perform in a specific time (a time unit). So we can say, our system executes our programs with x clock speed.</p><p><strong>Problems:</strong> Because the day after day technology is getting advance, So design of processor which takes cares of our task getting compact and complex. So many constraints started to come when we were working with ONE processor, and started to limit out the maximum clock speed of processors. So the designer looked for other ways to increase the total performance of their chips.</p><p><strong>Solution:</strong> The solution is, they settled on increasing the number of processor cores on each chip. By increasing the number of cores, a single chip could execute more instructions per second without increasing the CPU speed (Clock Speed) or changing the chip size or other thermal characteristics.</p><p><strong>Another Problem:</strong> So we have understood about the need of cores, now the next thing is How to use these cores? How to take advantage of the extra cores? We have n number of cores now… This means they can execute our instructions simultaneously. If we have two different task then they can executed parallel. So we need a software now, A software that can use these cores and perform task simultaneously or can do multiple things parallel.</p><h2 id="thread"><span class="mr-2">Thread</span><a href="#thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Here comes the Threads, We have multitasking operating systems like OS X or iOS which has got the thread APIs to work with these cores.</p><p>From a technical standpoint, a thread is a combination of the kernel-level and application-level coding (data structure), which is needed to manage the execution of code or a task. The kernel-level structures coordinate the dispatching of events to the thread and the preemptive scheduling of the thread on one of the available cores. The application-level structures include the call stack for storing function calls and the structures the application needs to manage and manipulate the thread’s attributes and state.</p><p>Having multiple threads in an application provides two very important potential advantages:</p><ul><li>Multiple threads can improve an application’s perceived responsiveness.<li>Multiple threads can improve an application’s real-time performance on multicore systems.</ul><p>With multicore computers common these days, threads provide a way to increase performance in some types of applications. Threads that perform different tasks can do so simultaneously on different processor cores, making it possible for an application to increase the amount of work it does in a given amount of time.Threads let us solve two tricky problems:</p><ul><li><strong>Parallel computation</strong> — In this world of multicore CPUs, many tasks will run faster if you divide the work between threads that are scheduled on different cores. This approach can be useful even on a single core system. Specifically, if your computation thread spends some fraction of its time blocked (for example, waiting for disk I/O), you can use multiple threads to do useful computation on one thread while the other thread is blocked.<li><strong>Asynchronous computation</strong> — If you have some long-running computation to do and, as is the case on iOS, you must keep the main thread responsive, you can move that computation to a secondary thread. This allows your main thread to treat the computation as it would any other asynchronous operation.</ul><p>A common approach is to use the NSThread API directly, or perhaps take advantage of Cocoa’s- <em>performSelectorInBackground:withObject</em>: method.</p><h3 id="nsthread-the-traditional-way"><span class="mr-2">NSThread: (The traditional Way)</span><a href="#nsthread-the-traditional-way" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Cocoa implements threads using the NSThread class, Foundation framework contains this class.<li>Cocoa also provides methods on NSObject for spawning new threads and executing code on already-running threads.<li>Based on POSIX ‘Portable Operating System Interface’ threading APIs (Pthreads), now a days every thread is POSIX<li>Mac OS X (Mavericks) is 100% POSIX compliant.</ul><h3 id="hazards-of-threaded-programming"><span class="mr-2">Hazards of threaded programming</span><a href="#hazards-of-threaded-programming" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>However, threads are not always the right solution. Threads have a significant cost, in terms of both memory and, more importantly, code complexity.</p><p>Problem will arise when you increase number of cores in your system. Why, because our threaded code does not scale vary well, to arbitrary numbers of cores. We cannot create as many threads as there are cores and expect a program to run well. Its very challenging for an application to compute your task that can use available number of cores in your system efficiently. Even if you manage to do so, to get the numbers correct, there is still a challenge to run these many thread efficiently and keeping them from interfering with one another.</p><p>Although threads have been around for many years and continue to have their uses, they do not solve the general problem of executing multiple tasks in a scalable way. With threads, the actual burden of creating a scalable solution rests squarely on the shoulders of you, the developer.</p><ul><li><strong>UIKit Access:</strong> Code ends up calling UIKit on a secondary thread, which is not allowed.<li><strong>DB Access:</strong> Not calling database function on same thread (Creating DB on main, then executing on another may cause you crash)<li><strong>Stale Result:</strong> Accessing a property with multiple threads leaves the user interface showing stale results.<li><strong>Cancellation:</strong> It would be nice if we could stop a thread, which needs to be discarded, so that it doesn’t waste CPU cycles, battery life, and memory.<li><strong>Thread-safe De-allocation:</strong> If you run any threaded code within UIKit objects (such as a view controller, where the -dealloc method typically releases UIView objects), there’s a chance that the object’s –dealloc method will be called on a secondary thread.</ul><p><strong>Solutions</strong> - Lets summarize the problem: There must be a way for an app to take advantage of multiple cores. And Solution has to be simple:  provides the solution of all these problems.</p><ul><li>Operations <em>(NSOperationQueue)</em><li>GCD <em>(Grand Central Dispatch)</em><li>Notification queue  (<em>addObserverForName:object:queue:usingBlock:)</em><li>Asynchronous (<em>NSURLConnections, NSURLSessions)</em><li>Timers (<em>NSTimer)</em><li>Separate Processes</ul><p>In many cases it’s a good idea to use the asynchronous APIs available in iOS instead.</p><ul><li><strong>Periodic execution</strong> — Starting a thread just to execute code periodically is never a good idea. You should use NSTimer instead.<li><strong>Networking</strong> — On a typical iOS device, the CPU is much faster than the network so, if you start a thread to do your networking synchronously, that thread will spend most of its time blocked. A better approach is to use the asynchronous networking APIs provided by iOS.</ul><h2 id="nsoperations"><span class="mr-2">NSOperations</span><a href="#nsoperations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>An abstract class comes to the rescue! NSOperation and NSOperationQueue are higher level classes that have greatly simplified the process of dealing with multiple threads.</p><ul><li>Introduced in OS X v10.5, an operation object is a wrapper for a task that would normally be executed on a secondary thread.<li>This wrapper hides the thread management aspects of performing the task, leaving you free to focus on the task itself.<li>We typically use these objects in conjunction with an operation queue object, which actually manages the execution of the operation objects on one or more threads.<li>We only need to focus on business logic, rest NSOperation does it. It make sure our business logic works correctly with other system objects.<li>It encapsulates (executes) the code and data associated with a single task.<li>Because it is abstract, we do not use this class directly but instead subclass or use one of the system-defined subclasses (NSInvocationOperation or NSBlockOperation) to perform the actual task.<li>An operation object is a single-shot object—that is, it executes its task once and cannot be used to execute it again.<li>And It’s a Thread Safe class.</ul><h3 id="nsoperations-features"><span class="mr-2">NSOperations Features</span><a href="#nsoperations-features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="manage-thread-lifecycle"><span class="mr-2"><strong>Manage Thread Lifecycle:</strong></span><a href="#manage-thread-lifecycle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>NSOperation is the one way to manage your threaded code, it takes care of the whole lifecycle of a thread from thread creation to destruction.<li>It provides the infrastructure for solving all of the problems discussed above.</ul><h4 id="asynchronous"><span class="mr-2"><strong>Asynchronous:</strong></span><a href="#asynchronous" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>NSOperation is a class that allows you to <strong>model asynchronous operations</strong> in a structured fashion. It Encapsulate a unit of work in an object asynchronously.<li>It provides a way for the high-level parts of your application to start asynchronous operations without worrying about the details of how they are executed.<li>Operation objects are non-concurrent by default.</ul><h4 id="kvo-compliant-properties"><span class="mr-2"><strong>KVO Compliant Properties</strong>:</span><a href="#kvo-compliant-properties" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The NSOperation class is key-value coding (KVC) and key-value observing (KVO) compliant for several of its properties. As needed, you can observe these properties to control other parts of your application. The properties you can observe include the following:</p><ul><li><em>isCancelled - read-only property</em><li><em>isConcurrent - read-only property</em><li><em>isExecuting - read-only property</em><li><em>isFinished - read-only property</em><li><em>isReady - read-only property</em><li><em>dependencies - read-only property</em><li><em>queuePriority - readable and writable property</em><li><em>completionBlock - readable and writable property</em></ul><h4 id="operation-dependencies"><span class="mr-2"><strong>Operation Dependencies:</strong></span><a href="#operation-dependencies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Dependencies are a convenient way to execute operations in a specific order.</p><ul><li>You can make operations dependent on other operations, and thereby establish chains of operation execution and operation fan in.<li>You can add and remove dependencies for an operation using the <em>addDependency</em>: and <em>removeDependency</em>: methods.<li>By default, an operation object that has dependencies is not considered ready until all of its dependent operation objects have finished executing. Once the last dependent operation finishes, however, the operation object becomes ready and able to execute.<li>The dependencies supported by NSOperation make no distinction about whether a dependent operation finished successfully or unsuccessfully. (In other words, canceling an operation similarly marks it as finished.) It is up to you to determine whether an operation with dependencies should proceed in cases where its dependent operations were cancelled or did not complete their task successfully. This may require you to incorporate some additional error tracking capabilities into your operation objects.<li>Any operation can be dependent on any number of operations. When you make operation A dependent on operation B, even though you call “start” on operation A, it will not start unless operation B isFinished is true. For example:</ul><p><em>DownloadOperation *downloadOp = [[DownloadOperation alloc] init]; // DownloadOperation is a subclass of NSOperation</em> <em>FilterOperation *filterOp = [[MyFilterOperation alloc] init]; // FilterOperation is a subclass of NSOperation</em> <em>[filterOp addDependency:downloadOp];</em> <em>// To remove dependencies:</em> <em>[filterOp removeDependency:downloadOp];</em></p><h4 id="priority"><span class="mr-2"><strong>Priority:</strong></span><a href="#priority" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Sometimes the operation you wish to run in the background is not crucial and can be performed at a lower priority. You set the priority of an operation by using “<em>setQueuePriority</em>:”.</p><p>[filterOp setQueuePriority:NSOperationQueuePriorityVeryLow];</p><p>Other options for thread priority are:</p><ul><li><em>NSOperationQueuePriorityLow,</em><li><em>NSOperationQueuePriorityNormal,</em><li><em>NSOperationQueuePriorityHigh, and</em><li><em>NSOperationQueuePriorityVeryHigh.</em></ul><p>When you add operations to a queue, the NSOperationQueue looks through all of the operations, before calling “start” on them. Those that have higher priorities will be executed first. Operations with the same priority will be executed in order of submission to the queue (FIFO).</p><h4 id="completion-block"><span class="mr-2"><strong>Completion block:</strong></span><a href="#completion-block" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Another useful method in NSOperation class is <em>setCompletionBlock</em>:. If there is something that you want to do once the operation has been completed, you can put it in a block and pass it into this method. Note that there is no guarantee the block will be executed on the main thread.</p><p>[filterOp setCompletionBlock: ^{ NSLog(@”Finished filtering an image.”); }]; </p><h4 id="thread-confinement"><span class="mr-2"><strong>Thread Confinement:</strong></span><a href="#thread-confinement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>NSOperation encourages a programming model called <strong>Thread Confinement</strong>. In this model the resources used by the thread are owned by that thread, not shared between threads, where you can still specify priorities and manage dependencies between operations.</p><h4 id="cancellation"><span class="mr-2"><strong>Cancellation:</strong></span><a href="#cancellation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>An operation can also be canceled. Canceling an operation object leaves the object in the queue but notifies the object that it should abort its task as quickly as possible. For currently executing operations, this means that the operation object’s work code must check the cancellation state, stop what it is doing, and mark itself as finished. In OS X v10.6 and later, canceling an operation causes the operation to ignore any dependencies it may have. This behavior makes it possible for the queue to execute the operation’s start method as soon as possible. The start method, in turn, moves the operation to the finished state so that it can be removed from the queue.</p><h4 id="concurrent-vsnon-concurrent-operations"><span class="mr-2"><strong>Concurrent vs Non-Concurrent Operations:</strong></span><a href="#concurrent-vsnon-concurrent-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>NSOperation objects are non-concurrent by default. But If you plan on executing an operation object manually, instead of adding it to a queue, you can design your operation to execute in a concurrent or non-concurrent manner.</p><p>In a <strong>non-concurrent operation</strong>, the operation’s task is performed synchronously—that is, the operation object does not create a separate thread on which to run the task. Thus, when you call the start method of a non-concurrent operation directly from your code, the operation executes immediately in the current thread. By the time the start method of such an object returns control to the caller, the task itself is complete.</p><p>A <strong>concurrent operation</strong> runs asynchronously. In other words, when you call the start method of a concurrent operation, that method could return before the corresponding task is completed. This might happen because the operation object created a new thread to execute the task or because the operation called an asynchronous function.</p><p><strong>Note:</strong> In OS X v10.6, operation queues ignore the value returned by isConcurrent and always call the start method of your operation from a separate thread. In OS X v10.5, however, operation queues create a thread only if isConcurrent returns NO. In general, if you are always using operations with an operation queue, there is no reason to make them concurrent.</p><p>A good example of a concurrent operation is one that executes an HTTP request using the NSURLConnection API.</p><h4 id="notes-on-nsoperation-caveats"><span class="mr-2"><strong>Notes on NSOperation (<em>Caveats</em>)</strong></span><a href="#notes-on-nsoperation-caveats" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>A finished operation cannot be restarted.<li>You cannot reuse an operation. Once it is added to a queue, you give up ownership. If you want to use the same operation class again, you must create a new instance.<li>If you cancel an operation, it will not happen instantly. It will happen at some point in the future when someone explicitly checks for <em>isCancelled == YES</em> in “main”; otherwise, the operation will run until it is done.<li>Always check for the isCancelled property frequently. You don’t want to run a operation in the background if it is no longer required!</ul><h2 id="nsoperationqueue"><span class="mr-2">NSOperationQueue</span><a href="#nsoperationqueue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>NSOperationQueue also has a fairly simple interface. It is even simpler than NSOperation, because you don’t need to subclass it, or override any method — you simply create one. It is a good practice to give your queue a name; this way you can identify your operation queues at run time and make it debugging easier.</p><h3 id="nsoperationsqueue-features"><span class="mr-2">NSOperationsQueue Features</span><a href="#nsoperationsqueue-features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="add-operations"><span class="mr-2"><strong>ADD Operations:</strong></span><a href="#add-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The NSOperationQueue class regulates the execution of a set of NSOperation objects. Each operation is executed by an operation queue (NSOperationQueue). As soon as an operation is added to a queue, you should relinquish ownership by sending a release message to the operation object (if using manual reference counting, no ARC), and the queue will then assume responsibility to start the operation. At this point, it is up to the queue as to when it will call “start”.</p><p><em>DownloadOperation *downloadOp = [[DownloadOperation alloc] init];</em> [myQueue addOperation:downloadOp]; [downloadOp release]; // Manual Reference Counting</p><h4 id="ready--execute-operations"><span class="mr-2"><strong>READY</strong> &amp; <strong>EXECUTE Operations:</strong></span><a href="#ready--execute-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>An operation object is not considered ready to execute until all of its dependent operations have finished executing.<li>Operations within the queue (but not yet executing) are themselves organized according to priority levels and inter-operation object dependencies and are executed accordingly.<li>An operation queue executes its queued operation objects based on their priority and readiness. If all of the queued operation objects have the same priority and are ready to execute when they are put in the queue—that is, their <em>isReady</em> method returns <em>YES</em>—they are executed in the order in which they were submitted to the queue (<strong>FIFO</strong>).</ul><h4 id="pending-operations"><span class="mr-2"><strong>PENDING Operations:</strong></span><a href="#pending-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>At any time you can ask a queue which operations are in the queue, and how many operations there are in total. Remember that only those operations that are waiting to be executed, and those that are running, are kept in the queue. As soon as an operation is done, it is gone from the queue.</p><p>NSArray *active_and_pending_operations = myQueue.operations; NSInteger count_of_operations = myQueue.operationCount;</p><h4 id="multiple-queues"><span class="mr-2"><strong>MULTIPLE Queues:</strong></span><a href="#multiple-queues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>An application may create multiple operation queues and submit operations to any of them. You can create operation queues to model your problem space. For example, a file copying program could use one operation queue per disk to avoid thrashing the disk head.</p><h4 id="threads--queues"><span class="mr-2"><strong>THREADS &amp; QUEUES</strong></span><a href="#threads--queues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>A queue is not the same thing as thread. A queue can have multiple threads. Each operation within a queue is running on its own thread. Take the example where you create one queue, and add three operations to it. The queue will launch three separate threads, and run all operations concurrently on their own threads.</p><p><strong>How many threads</strong> will be created? That’s a good question! :) It depends on the hardware. By default, NSOperationQueue class will do some magic behind the scenes, decide what is best for the particular platform the code is running on, and will launch the maximum possible number of threads.</p><p>Consider the following example. Assume the system is idle, and there are lots of resources available, so NSOperationQueue could launch something like eight simultaneous threads. Next time you run the program, the system could be busy with other unrelated operations which are consuming resources, and NSOperationQueue will only launch two simultaneous threads.</p><h4 id="queue-width"><span class="mr-2"><strong>Queue Width:</strong></span><a href="#queue-width" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Each queue has a maximum number of operations that it will execute in parallel / concurrently (<em>maxConcurrentOperationCount</em>), commonly known as the <strong>Queue Width</strong>. This width defaults to a value that’s appropriate for the device on which you’re running, but you can set it to a value that’s appropriate for the task at hand. For example, you can guarantee that operations are serialized (executed one at a time) by setting the queue width to 1. Or, if your operations hit the network, you can use the queue width to limit the number of concurrent network operations.</p><p>NSOperationQueue may choose to run any number of concurrent operations, but it won’t be more than the maximum.</p><p>myQueue.MaxConcurrentOperationCount = 3;</p><p>If you change your mind, and want to set MaxConcurrentOperationCount back to its default, you would perform the following changes:</p><p>myQueue.MaxConcurrentOperationCount = NSOperationQueueDefaultMaxConcurrentOperationCount;</p><p><strong>Serial Queue:</strong> For a queue whose maximum number of concurrent operations is set to 1, this equates to a <strong>Serial Queue</strong>. However, you should never rely on the serial execution of operation objects. Changes in the readiness of an operation can change the resulting execution order.</p><h4 id="pause-suspend-queue"><span class="mr-2"><strong>Pause (Suspend) Queue:</strong></span><a href="#pause-suspend-queue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>We can pause a queue by setting <em>setSuspended:YES.</em> This will suspend all operations in a queue — you can’t suspend operations individually. To resume the queue, simply <em>setSuspended:NO</em>.</p><p>// Suspend a queue  [myQueue setSuspended:YES];  // Resume a queue [myQueue setSuspended: NO];</p><h4 id="canceloperations"><span class="mr-2"><strong>CANCEL Operations:</strong></span><a href="#canceloperations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>After being added to a queue, an operation remains in that queue until it is explicitly canceled or finishes executing its task. To cancel all operations in a queue, you simply call “cancelAllOperations”. The reason is that cancelAllOperations doesn’t do much, except that it calls “cancel” on every operation in the queue — it doesn’t do anything magical! :)</p><p>If an operation has not yet started, and you call “cancel” on it, the operation will be cancelled and removed from the queue. However, if an operation is already executing, it is up to that individual operation to recognize the cancellation (by checking the isCancelled property) and stop what it is doing.</p><p>[myQueue cancelAllOperations];</p><h4 id="kvo-compliant-properties-1"><span class="mr-2"><strong>KVO-Compliant Properties</strong></span><a href="#kvo-compliant-properties-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The NSOperationQueue class is key-value coding (KVC) and key-value observing (KVO) compliant. You can observe these properties as desired to control other parts of your application. The properties you can observe include the following:</p><ul><li><em>operations - read-only property</em><li><em>operationCount - read-only property</em><li><em>maxConcurrentOperationCount - readable and writable property</em><li><em>suspended - readable and writable property</em><li><em>name - readable and writable property</em></ul><p>Although you can attach observers to these properties, you should not use Cocoa bindings to bind them to elements of your application’s user interface. Code associated with your user interface typically must execute only in your application’s main thread. However, KVO notifications associated with an operation queue may occur in any thread.</p><h4 id="add-operation-with-block"><span class="mr-2"><strong>Add Operation With Block:</strong></span><a href="#add-operation-with-block" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>If you have a simple operation that does not need to be subclassed, you can simply pass it into a queue by way of a block. If you want to send any data back from the block, remember that you should not pass into the block any strong reference pointers; instead, you must use a weak reference. Also, if you want to do something that is related to the UI in the block, you must do it on the main thread:</p><p>UIImage *myImage = nil; // Create a weak reference __weak UIImage *myImage_weak = myImage; // Add an operation as a block to a queue [myQueue addOperationWithBlock: ^ { // a block of operation NSURL *aURL = [NSURL URLWithString:@”http://www.somewhere.com/image.png”]; NSError *error = nil; NSData *data = [NSData dataWithContentsOfURL:aURL options:nil error:&amp;error]; If (!error) [myImage_weak imageWithData:data]; // Get hold of main queue (main thread) [[NSOperationQueue mainQueue] addOperationWithBlock: ^ { myImageView.imag e = myImage_weak; // updating UI  }]; }];</p><h5 id="presentation-pptand-sample-code"><span class="mr-2"><a href="https://speakerdeck.com/izeeshan/multi-threading-using-nsoperation" title="Presentation PPT"><span class="mr-2">Presentation PPT</a> and <a href="https://github.com/zeeshankhan/ZKNSOperationUse" title="Use of NSOperation"><span class="mr-2">Sample Code</a></span><a href="#presentation-pptand-sample-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><h5 id="thanks-for-reading-"><span class="mr-2">Thanks for reading :)</span><a href="#thanks-for-reading-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><h5 id="second-draft-of-presentation-is-on-its-way-stay-tuned"><span class="mr-2">Second draft of presentation is on its way… stay tuned!!</span><a href="#second-draft-of-presentation-is-on-its-way-stay-tuned" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technical-posts/'>technical-posts</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/multithreading/" class="post-tag no-text-decoration" >multithreading</a> <a href="/tags/nsoperation/" class="post-tag no-text-decoration" >nsoperation</a> <a href="/tags/nsthread/" class="post-tag no-text-decoration" >nsthread</a> <a href="/tags/posix/" class="post-tag no-text-decoration" >posix</a> <a href="/tags/threads/" class="post-tag no-text-decoration" >threads</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Multi-Threading using NSOperation - zeeshan&#39;s blog&amp;url=https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Multi-Threading using NSOperation - zeeshan&#39;s blog&amp;u=https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://zeeshankhan.github.io/posts/multi-threading-using-nsoperation/&amp;text=Multi-Threading using NSOperation - zeeshan&#39;s blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/view/">iOS View</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/thread-safe-vs-thread-un-safe/"><div class="card-body"> <em class="timeago small" data-ts="1408305600" > 2014-08-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Thread Safe vs Thread Un-Safe</h3><div class="text-muted small"><p> Thread safe and Thread un-safe objects: Thread safe objects are safe to pass from one thread to another. On the other hand you may get stale value if you try to access a thread unsafe object wi...</p></div></div></a></div><div class="card"> <a href="/posts/threadsafe-singleton/"><div class="card-body"> <em class="timeago small" data-ts="1409428800" > 2014-08-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Is your Singleton Thread-Safe?</h3><div class="text-muted small"><p> First, lets have a look into the concepts of some Terminologies: Singleton A singleton class returns the same instance no matter how many times an application requests it. A typical class permits...</p></div></div></a></div><div class="card"> <a href="/posts/dispatch-barriers/"><div class="card-body"> <em class="timeago small" data-ts="1409688000" > 2014-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Handling Shared Resources using Dispatch Barriers</h3><div class="text-muted small"><p> Handling Thread-Unsafe Shared Resource In the last post, we have discussed about creating thread-safe singleton objects. But creating a thread-safe singleton does not solve all the issues. If your...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/nsrunloop-understanding/" class="btn btn-outline-primary" prompt="Older"><p>NSRunLoop understanding</p></a> <a href="/posts/thread-safe-vs-thread-un-safe/" class="btn btn-outline-primary" prompt="Newer"><p>Thread Safe vs Thread Un-Safe</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
