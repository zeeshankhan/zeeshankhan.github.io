<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Local HTTP Server for iOS" /><meta name="author" content="Zeeshan Khan" /><meta property="og:locale" content="en" /><meta name="description" content="Problem (Features)" /><meta property="og:description" content="Problem (Features)" /><link rel="canonical" href="https://zeeshankhan.github.io/posts/local-http-server-for-ios/" /><meta property="og:url" content="https://zeeshankhan.github.io/posts/local-http-server-for-ios/" /><meta property="og:site_name" content="zeeshan’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-08-25T00:00:00+04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Local HTTP Server for iOS" /><meta name="twitter:site" content="@zeeshan_khan" /><meta name="twitter:creator" content="@Zeeshan Khan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeeshan Khan"},"dateModified":"2014-08-25T00:00:00+04:00","datePublished":"2014-08-25T00:00:00+04:00","description":"Problem (Features)","headline":"Local HTTP Server for iOS","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeeshankhan.github.io/posts/local-http-server-for-ios/"},"url":"https://zeeshankhan.github.io/posts/local-http-server-for-ios/"}</script><title>Local HTTP Server for iOS | zeeshan's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zeeshan's blog"><meta name="application-name" content="zeeshan's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sample/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zeeshan's blog</a></div><div class="site-subtitle font-italic">Recording my learnings from  development</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/zeeshankhan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zeeshan_khan" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['izeeshankhan','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Local HTTP Server for iOS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Local HTTP Server for iOS</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1408910400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2014-08-25 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2518 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h2 id="problemfeatures"><span class="mr-2"><strong>Problem (Features)</strong></span><a href="#problemfeatures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Yeah, because what I feel is, everything starts with a Problem, when we face problems, issues. We put our thoughts, we start to work on it, we come up with some solutions, we build something. Thats what we do. Right? Since we are in IT field, we are always into trouble :], so many problems, so many issues, we solve one another comes up, sometimes they are so many. A big nerd have said once:</p><h5 id="a-software-is-always-work-in-progress"><span class="mr-2"><em>“A Software is always work in progress…”</em></span><a href="#a-software-is-always-work-in-progress" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>So lets start with some problems which going to be our features of our final product. Here we’ll be discussing only about client server based issue, as where we work the most.</p><p><strong>Client Demo</strong> – Problem comes when we have to demo our app to the client, what if server is down in that particular time. How we going to present our app? We’ll place dummy data here and there and then we’ll put so many if conditional blocks in our code to read from those dummy data instead of hitting web services. Right? We are not going to do that from now on.</p><p><strong>Slow Network Connectivity</strong> – How do we test the slow network connectivity? Some people use our app with 3G/LTE network, some don’t. Some use it with WIFI or lets say 2G network. We always have to make sure that our application should work in every possible condition. It should show proper message, irrespective of network reachability.</p><p><strong>Mandatory Fields Check</strong> – Generally when we write client server application we deal with so many GET/POST http header fields or post body fields. In which some are mandatory and some fields are non mandatory. For mandatory fields every time we have test it with server and wait for the response. What if the server has confirmed some mandatory fields and they have implemented it? Or our application might get stuck if we do not implement a mandatory field and server respond to it on production.</p><p><strong>Large Image / Video Upload</strong> – How do we make sure that your application is sending image/video data correctly.</p><p><strong>Data Formatting and Validation</strong> – GET/POST body data validation and formatting, JSON/XML validation or Email/DOB validation checks.</p><p><strong>Random Error Probability</strong> – How our application behaves when server sends some error randomly. Its pretty interesting, the thought about Error Probability is like receiving errors from server randomly and seeing how our application is responding to it.</p><p><strong>UI Refreshing</strong> – This is what we should always take care of, because this is what the end user deals with, here is what the experience they get.</p><p><strong>Session Setup</strong> – If you want to check, when the server starts and ends the session.</p><h2 id="proxy-server"><span class="mr-2"><strong>Proxy Server</strong></span><a href="#proxy-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>And here comes the Proxy Server <em>(Local Host/127.0.0.1).</em> Its HTTP, because it is one of the simpler protocols to implement for communication between computers. Since there is no APIs for <strong>Stubbed</strong> data downloading or data synchronisation; embedding a Proxy server in your application, is one of the best ways to transfer data from our local host to our iOS / Mac OS X applications. It’s an asynchronous networking using GCD and standard sockets programming between our local host and iOS applications. Here, I’ll show you how to write your own simple but extensible HTTP server for iOS applications. The server classes will also work on Mac OS X.</p><h3 id="how-to-configure"><span class="mr-2"><strong>How to configure</strong></span><a href="#how-to-configure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Its pretty simple to configure HTTP Server. You’ll see those couple of lines of code to do the same. We only have to start a socket and attach a listener to it. It includes just four steps, that’s it. It is just a tiny HTTP server but the approach will allow you to quickly integrate HTTP communications into any application.</p><ul><li>Start Server - Open a Socket<li>Receive Incoming Connections<li>Response Handling<li>Stop Server - Close Socket</ul><h3 id="framework-needed"><span class="mr-2"><strong>Framework Needed</strong></span><a href="#framework-needed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Just three frameworks needed to start with and those are:</p><p>#import &lt;sys/socket.h&gt; //For #defines like AF_INET protocol family.</p><p>#import &lt;netinet/in.h&gt; //Socket address structure and others defined parameter values.</p><p>#import &lt;CFNetwork/CFNetwork.h&gt; //Core Network APIs <em>(need to add into project).</em></p><h2 id="opening-a-socket"><span class="mr-2"><strong>Opening a Socket</strong></span><a href="#opening-a-socket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Most server communications, HTTP included, begin by creating a socket for listening. Sockets in Cocoa can be created and configured entirely using the CoreFoundation <em>CFSocket</em> API. It easier — But we still have a large block of boilerplate code to throw down just to open a socket.</p><h3 id="create-socket-object"><span class="mr-2"><strong>Create Socket object:</strong></span><a href="#create-socket-object" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>CFSocketRef socket = CFSocketCreate(kCFAllocatorDefault, PF_INET, SOCK_STREAM, IPPROTO_TCP, 0, NULL, NULL);</p><p><em>CFSocketCreate</em> creates a <em>CFSocket</em> object of a specified protocol and type. Here we pass the parameters of protocol family, stream socket and TCP protocol. <em>kCFAllocatorDefault</em> is used for current default allocator.</p><h3 id="get-native-socket"><span class="mr-2"><strong>Get Native Socket:</strong></span><a href="#get-native-socket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>int reuse = true; int fileDescriptor = CFSocketGetNative(socket); setsockopt(fileDescriptor, SOL_SOCKET, SO_REUSEADDR, (void *)&amp;reuse, sizeof(int));</p><p><em>CFSocketGetNative</em> returns the native socket associated with a <em>CFSocket</em> object. If <em>CFSocket</em> object has been invalidated, it returns -1 (<em>INVALID_SOCKET)</em>.</p><h3 id="bind-socket-to-address"><span class="mr-2"><strong>Bind Socket to address:</strong></span><a href="#bind-socket-to-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>struct sockaddr_in address; memset(&amp;address, 0, sizeof(address)); address.sin_len = sizeof(address); address.sin_family = AF_INET; address.sin_addr.s_addr = htonl(INADDR_ANY); NSInteger portNumber = 8080; address.sin_port = htons(portNumber); CFDataRef addressData = CFDataCreate(NULL, (const UInt8 *)&amp;address, sizeof(address)); CFSocketSetAddress(socket, addressData);</p><p><em>sockaddr_in</em> is a C structure for socket address parameters like socket address, port number and etc. We create a <em>CFData</em> object containing a <em>struct</em> <em>sockaddr</em> appropriate for the protocol family of socket object (<em>struct sockaddr_in</em> or <em>struct sockaddr_in6,</em> for example). This data object is used only for the duration of the function call.</p><p><em>CFSocketSetAddress</em> binds a local address to a <em>CFSocket</em> object and configures it for listening. This function binds the socket by calling bind, and if the socket supports it, configures the socket for listening by calling listen with a backlog of 256. Once the socket object is bound to address, depending on the socket’s protocol, other processes and computers can connect to socket object. It returns an error code indicating success or failure.</p><h2 id="receive-incoming-notification"><span class="mr-2"><strong>Receive Incoming Notification</strong></span><a href="#receive-incoming-notification" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>So, we are done with opening a socket to listen for TCP connections on the port specified by <em>HTTP_SERVER_PORT</em> (which was 8080). After the socket is setup, Cocoa handles a little more of the work so things get easier. Cocoa does a pretty good job for us by invoking an incoming connection notification, we only have to register a listener to it by constructing a file handler from native socket object. We can receive each incoming connection by constructing an <em>NSFileHandle</em> from the fileDescriptor above and listening for connection notifications.</p><h3 id="constructing-file-handler"><span class="mr-2"><strong>Constructing File Handler</strong></span><a href="#constructing-file-handler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSFileHandle *listeningHandle = [[NSFileHandle alloc] initWithFileDescriptor:fileDescriptor closeOnDealloc:YES]; [listeningHandle acceptConnectionInBackgroundAndNotify];</p><p><em>initWithFileDescriptor</em> initialises and returns a file handle object associated with the specified POSIX file descriptor and deallocation policy. If flag is NO, the file descriptor you pass in to this method is not owned by the file handle object. In such a case, you are responsible for closing the file descriptor at some point after disposing of the file handle object. If you want the file handle object to close the descriptor for you automatically, pass YES for the flag parameter.</p><h3 id="attach-connection-listener"><span class="mr-2"><strong>Attach Connection Listener</strong></span><a href="#attach-connection-listener" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(receiveIncomingConnectionNotification:) name:NSFileHandleConnectionAcceptedNotification object:nil];</p><h3 id="receive-file-handler"><span class="mr-2"><strong>Receive File Handler</strong></span><a href="#receive-file-handler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSDictionary *userInfo = [notification userInfo]; NSFileHandle *incomingFileHandle = [userInfo objectForKey:NSFileHandleNotificationFileHandleItem];</p><p><em>NSFileHandleNotificationFileHandleItem</em> is a key in the user info dictionary in a <em>NSFileHandleConnectionAcceptedNotification</em> notification. The corresponding value is the <em>NSFileHandle</em> object representing the “near” end of a socket connection.</p><h3 id="attach-incoming-data-listener"><span class="mr-2"><strong>Attach Incoming Data Listener</strong></span><a href="#attach-incoming-data-listener" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(receiveIncomingDataNotification:) name:NSFileHandleDataAvailableNotification object:incomingFileHandle];  [incomingFileHandle waitForDataInBackgroundAndNotify];</p><p>Then we attach another listener with this DataFileHandler for incoming data. <em>NSFileHandleDataAvailableNotification,</em> this notification is posted when the file handle determines that data is currently available for reading in a file or at a communications channel. The notification object is the NSFileHandle object that sent the notification. This notification does not contain a userInfo dictionary instead it contains availableData for that connection.</p><h2 id="two-file-handlers"><span class="mr-2"><strong>Two file handlers</strong></span><a href="#two-file-handlers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>[caption id=”attachment_143” align=”aligncenter” width=”646”]<a href="https://izeeshan.files.wordpress.com/2014/08/3.png"><img data-src="https://izeeshan.files.wordpress.com/2014/08/3.png?w=646" alt="Two file handlers on Local HTTP Server" data-proofer-ignore></a> Two file handlers on Local HTTP Server[/caption]</p><p>When <em>receiveIncomingConnectionNotification:</em> function is invoked, each new incoming connection will get its own NSFileHandle. If you’re keeping track, that was:</p><ul><li>1 file handle (<em>listeningHandle</em>) <em><strong>manually created</strong></em> from the socket <em>fileDesriptor</em> to listen on the socket for new connections, a <strong>Connection Listening</strong> file handler.<li>1 file handle <em><strong>automatically created</strong></em> for <em>each</em> new connection received through listeningHandle. We’ll continue to listen to these new handles (the keys in the incomingRequests dictionary) to record the data for each connection, a <strong>Data Listening</strong> file handler for listing to available data on stream.</ul><h2 id="receive-incoming-data"><span class="mr-2"><strong>Receive Incoming Data</strong></span><a href="#receive-incoming-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="handle-incoming-data"><span class="mr-2"><strong>Handle Incoming Data</strong></span><a href="#handle-incoming-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSFileHandle *incomingFileHandle = [notification object]; NSData *data = [incomingFileHandle availableData];</p><h3 id="create-http-message-to-store-date"><span class="mr-2"><strong>Create HTTP Message to store date</strong></span><a href="#create-http-message-to-store-date" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>CFHTTPMessageRef incomingRequest = CFHTTPMessageCreateEmpty(kCFAllocatorDefault, TRUE); CFHTTPMessageAppendBytes(incomingRequest, [data bytes], [data length]);</p><p>So, we’ve received a new, automatically created file handle. Now we’ll create a <em>CFHTTPMessageRef</em> to store the incoming data we receive over the file handle. We store these as the objects in <em>incomingRequests</em> dictionary to allow easy access to the <em>CFHTTPMessageRef</em> for each file handle. <em>CFHTTPMessageCreateEmpty</em> creates and returns a new, empty <em>CFHTTPMessage</em> object then we call <em>CFHTTPMessageAppendBytes</em> to store an incoming serialised HTTP request message in the empty message object.</p><p><em>CFHTTPMessageAppendBytes</em> function appends the data specified by newBytes to the specified message object which was created by calling <em>CFHTTPMessageCreateEmpty</em>. The data is an incoming serialised HTTP request or response received from a client or a server. While appending the data, this function deserialises it, removes any HTTP-based formatting that the message may contain, and stores the message in the message object. You can then call <em>CFHTTPMessageCopyVersion</em>, <em>CFHTTPMessageCopyBody</em>, <em>CFHTTPMessageCopyHeaderFieldValue</em>, and <em>CFHTTPMessageCopyAllHeaderFields</em> to get the message’s HTTP version, the message’s body, a specific header field, and all of the message’s headers, respectively.</p><p>If the message is a request, you can also call <em>CFHTTPMessageCopyRequestURL</em> and <em>CFHTTPMessageCopyRequestMethod</em> to get the message’s request URL and request method, respectively.</p><p>If the message is a response, you can also call <em>CFHTTPMessageGetResponseStatusCode</em> and <em>CFHTTPMessageCopyResponseStatusLine</em> to get the message’s status code and status line, respectively.</p><p>The <em>CFHTTPMessageRef</em> is both storage and the parser for the incoming data. We can invoke <em>CFHTTPMessageIsHeaderComplete()</em> every time we add data to check when the HTTP headers are complete and we can spawn a response handler. The response handler is spawned in the <em>receiveIncomingDataNotification</em> method. The server stops listening to the file handle for the connection at this point but it doesn’t close it, since the file handle is passed to the response handler so that the HTTP response can be sent back over the same file handle.</p><p><strong>Sample Incoming Data</strong></p><p>GET / HTTP/1.1 Host: 127.0.0.1:8080 Accept-Encoding: gzip, deflate Accept: text/html,application/xhtml+xml,application/xml;q=0.9,/*;q=0.8 User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10) AppleWebKit/538.34.48 (KHTML, like Gecko) Version/8.0 Safari/538.35.8 Accept-Language: en-us DNT: 1 Connection: keep-alive</p><h2 id="handling-response"><span class="mr-2"><strong>Handling Response</strong></span><a href="#handling-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="parsing-request-data"><span class="mr-2"><strong>Parsing Request Data</strong></span><a href="#parsing-request-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSURL *requestURL = NSMakeCollectable(CFHTTPMessageCopyRequestURL(ref)); NSString *httpMethod = NSMakeCollectable(CFHTTPMessageCopyRequestMethod(ref)); NSDictionary *httpHeaderFields = NSMakeCollectable(CFHTTPMessageCopyAllHeaderFields(ref)); NSData *httpBody = NSMakeCollectable(CFHTTPMessageCopyBody(ref));</p><p>Now we can parse the HTTP request body, <em>NSMakeCollectable</em> makes a newly allocated Core Foundation object an <em>NSObject</em> which is eligible for collection. This function is a wrapper for <em>CFMakeCollectable</em>, but its return type is id—avoiding the need for casting when using Cocoa objects. This function may be useful when returning Core Foundation objects in code.</p><h3 id="create-http-response"><span class="mr-2"><strong>Create HTTP Response</strong></span><a href="#create-http-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSInteger responseCode = 200; CFHTTPMessageRef response = CFHTTPMessageCreateResponse(kCFAllocatorDefault, responseCode, NULL, kCFHTTPVersion1_1);</p><p>Begin sending a response over the fileHandle. Trivial cases can synchronously return a response but everything else should spawn a thread or otherwise asynchronously start returning the response data.</p><p><em>CFHTTPMessageCreateResponse()</em> creates and returns a <em>CFHTTPMessage</em> object for an HTTP response. This function returns a <em>CFHTTPMessage</em> object that you can use to build an HTTP response. Then call <em>CFHTTPMessageCopySerializedMessage()</em> to make the message ready for transmission by serialising it.</p><h3 id="add-response-header-fields"><span class="mr-2"><strong>Add Response header fields</strong></span><a href="#add-response-header-fields" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>CFHTTPMessageSetHeaderFieldValue(response, (CFStringRef)@”Content-Type”, (CFStringRef)@”text/plain”); CFHTTPMessageSetHeaderFieldValue(response, (CFStringRef)@”Connection”, (CFStringRef)@”close”);</p><p>We can call <em>CFHTTPMessageSetHeaderFieldValue()</em> function to set the message’s headers, <em>CFHTTPMessageSetHeaderFieldValue()</em> sets the value of a header field in an HTTP message, and calling <em>CFHTTPMessageSetBody()</em> to set the message’s body.</p><h3 id="add-data-length-in-header-fields"><span class="mr-2"><strong>Add Data Length in header fields</strong></span><a href="#add-data-length-in-header-fields" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>NSString *dataLength = [NSString stringWithFormat:@”%d”, fileData.length]; CFHTTPMessageSetHeaderFieldValue(response, (CFStringRef)@”Content-Length”, (CFStringRef)dataLength);</p><h3 id="serialise-http-response-in-data"><span class="mr-2"><strong>Serialise HTTP Response in Data</strong></span><a href="#serialise-http-response-in-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>CFDataRef headerData = CFHTTPMessageCopySerializedMessage(response);</p><p><em>CFHTTPMessageCopySerializedMessage()</em> serialises a <em>CFHTTPMessage</em> object. This function returns a copy of a <em>CFHTTPMessage</em> object in serialised format that is ready for transmission. It creates a self-contained copy of a <em>CFHTTPMessage</em>. This would be suitable for persistent storage or for transmitting over the network independently.</p><h2 id="sending-response"><span class="mr-2"><strong>Sending Response</strong></span><a href="#sending-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="write-http-header-data-and-response-data"><span class="mr-2"><strong>Write HTTP Header Data and Response Data</strong></span><a href="#write-http-header-data-and-response-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[incomingFileHandle writeData:(NSData*)headerData]; [incomingFleHandle writeData:fileData];</p><h3 id="close-file-handler-and-remove-listeners"><span class="mr-2"><strong>Close file handler and Remove Listeners</strong></span><a href="#close-file-handler-and-remove-listeners" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[incomingFileHandle closeFile]; [[NSNotificationCenter defaultCenter] removeObserver:self name:NSFileHandleDataAvailableNotification object:incomingFileHandle];</p><h2 id="stop-server"><span class="mr-2"><strong>Stop Server</strong></span><a href="#stop-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="remove-connection-listener"><span class="mr-2"><strong>Remove Connection Listener</strong></span><a href="#remove-connection-listener" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[[NSNotificationCenter defaultCenter] removeObserver:self name:NSFileHandleConnectionAcceptedNotification object:nil];</p><h3 id="close-socket"><span class="mr-2"><strong>Close Socket</strong></span><a href="#close-socket" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>[listeningHandle closeFile]; CFSocketInvalidate(socket); CFRelease(socket);</p><p><em>CFSocketInvalidate()</em> invalidates a <em>CFSocket</em> object, stopping it from sending or receiving any more messages.</p><p>You should always invalidate a socket object when you are through using it. Invalidating a <em>CFSocket</em> object prevents the object from sending or receiving any more messages, but does not release the socket object itself.</p><p>If a run loop source was created for s, the run loop source is invalidated.</p><p>If a release callback was specified in <em>CFSocketContext</em> object, this function calls it to release the object in the info field (which was provided when s was created).</p><p>By default, this call closes the underlying socket. If you have explicitly cleared the <em>kCFSocketCloseOnInvalidate</em> flag by calling <em>CFSocketSetSocketFlags</em>, you must close the socket yourself after calling this function.</p><h2 id="configure-in-app"><span class="mr-2"><strong>Configure In App</strong></span><a href="#configure-in-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="start-server"><span class="mr-2"><strong>Start Server</strong></span><a href="#start-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>func application(application: UIApplication!, didFinishLaunchingWithOptions launchOptions: NSDictionary!) -&gt; Bool func applicationWillEnterForeground(application: UIApplication!)</p><h3 id="stop-server-1"><span class="mr-2"><strong>Stop Server</strong></span><a href="#stop-server-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>func applicationDidEnterBackground(application: UIApplication!)</p><p>Normally there’s no need to run our server on any specific port. Technologies like Bonjour allow clients to dynamically discover the server’s port at runtime. However, for easy testing you may want force a certain port so you can just hit the refresh button.</p><p>There is no public (allowed in AppStore) method for iOS to run continuously in the background for our purposes (serving HTTP). So, we stop the server when the app is paused (if a users exits from the app or locks a device) and restart the server when the app is resumed (based on this document: <em>http://developer.apple.com/library/ios/#technotes/tn2277/_index.html</em> )</p><h2 id="solutions"><span class="mr-2"><strong>Solutions</strong></span><a href="#solutions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Set up Core Data or SQLite for dynamic tables<li>Add delay before Response Handling<li>Configure Error Probability On Response<li>Configure Session Setup<li>Add Server States <em>(Idle / Running)</em><li>Add Configurations like Port no, etc…</ul><p>Set up Core Data for any specific project because you cannot add dynamic tables to it. In this case you only have to populate the core data with dummy responses.</p><p>You can also build a layer of SQLite for dynamic tables. This will make your dummy server more scalable. Which can help others as well.</p><p><strong>Delay</strong> – You can add delays ask users to set the delay property for proxy server. This will help you to test slow network connectivity.</p><p><strong>Error Probability</strong> – Create a property which will count for all your requests. You can increase counter when some one hit your server and then respond with error response in specific counter value lets say for all even or all odd.</p><p><strong>Session setup</strong> – you can anytime configure it.</p><p><strong>Server State</strong> – Its good for end user and for server writer as well to keep the state of your server. Whether its in Idle or running state.</p><p><strong>Other Configurations</strong> – Like Port no. which can define any specific port no. Which will prevent others to guess.</p><h5 id="references"><span class="mr-2"><strong>References</strong></span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><ul><li>http://www.cocoawithlove.com/2009/07/simple-extensible-http-server-in-cocoa.html<li>https://github.com/robbiehanson/CocoaHTTPServer<li>https://developer.apple.com/library/ios/technotes/tn2277/_index.html</ul><h6 id="sample-project"><a href="https://github.com/zeeshankhan/ZKProxyServer" title="Sample Project">Sample Project</a></h6><h5 id="you-can-also-find-the-presentation-on-it-proxy-server-ppt"><span class="mr-2">You can also find the presentation on it, <a href="https://speakerdeck.com/izeeshan/proxy-server" title="Proxy Server PPT"><span class="mr-2">Proxy Server PPT</a></span><a href="#you-can-also-find-the-presentation-on-it-proxy-server-ppt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><h5 id="thanks-for-reading-"><span class="mr-2">Thanks for reading! :)</span><a href="#thanks-for-reading-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technical-posts/'>technical-posts</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cocoa-http-server/" class="post-tag no-text-decoration" >cocoa-http-server</a> <a href="/tags/http-server/" class="post-tag no-text-decoration" >http-server</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/localhost/" class="post-tag no-text-decoration" >localhost</a> <a href="/tags/max-os-x/" class="post-tag no-text-decoration" >max-os-x</a> <a href="/tags/networking/" class="post-tag no-text-decoration" >networking</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Local HTTP Server for iOS - zeeshan&#39;s blog&amp;url=https://zeeshankhan.github.io/posts/local-http-server-for-ios/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Local HTTP Server for iOS - zeeshan&#39;s blog&amp;u=https://zeeshankhan.github.io/posts/local-http-server-for-ios/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://zeeshankhan.github.io/posts/local-http-server-for-ios/&amp;text=Local HTTP Server for iOS - zeeshan&#39;s blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/view/">iOS View</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/dispatch-barriers/"><div class="card-body"> <em class="timeago small" data-ts="1409688000" > 2014-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Handling Shared Resources using Dispatch Barriers</h3><div class="text-muted small"><p> Handling Thread-Unsafe Shared Resource In the last post, we have discussed about creating thread-safe singleton objects. But creating a thread-safe singleton does not solve all the issues. If your...</p></div></div></a></div><div class="card"> <a href="/posts/hide-dismiss-present-model-view-controller-on-ipad/"><div class="card-body"> <em class="timeago small" data-ts="1343937600" > 2012-08-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hide / Dismiss Present Model View Controller on iPad</h3><div class="text-muted small"><p> If Base view controller is a View Controller then override this method - (BOOL)disablesAutomaticKeyboardDismissal {     return NO; } Be careful if you are displaying the modal with a UINavigatio...</p></div></div></a></div><div class="card"> <a href="/posts/ipad-keyboard-notifications/"><div class="card-body"> <em class="timeago small" data-ts="1343937600" > 2012-08-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iPad Keyboard Notifications for Show/Hide, Split &amp; Dock/Undock</h3><div class="text-muted small"><p> If your app is using iOS 5.0 and above then this is a very good link: http://adevelopingstory.com/blog/2012/05/the-ipad-split-keyboard-and-missing-notifications.html</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/thread-safe-vs-thread-un-safe/" class="btn btn-outline-primary" prompt="Older"><p>Thread Safe vs Thread Un-Safe</p></a> <a href="/posts/threadsafe-singleton/" class="btn btn-outline-primary" prompt="Newer"><p>Is your Singleton Thread-Safe?</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
