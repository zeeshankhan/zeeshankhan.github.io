<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Core Data Migration" /><meta name="author" content="Zeeshan Khan" /><meta property="og:locale" content="en" /><meta name="description" content="Core Data" /><meta property="og:description" content="Core Data" /><link rel="canonical" href="https://zeeshankhan.github.io/posts/core-data-migration/" /><meta property="og:url" content="https://zeeshankhan.github.io/posts/core-data-migration/" /><meta property="og:site_name" content="zeeshanâ€™s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-11-10T00:00:00+04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Core Data Migration" /><meta name="twitter:site" content="@zeeshan_khan" /><meta name="twitter:creator" content="@Zeeshan Khan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zeeshan Khan"},"dateModified":"2014-11-10T00:00:00+04:00","datePublished":"2014-11-10T00:00:00+04:00","description":"Core Data","headline":"Core Data Migration","mainEntityOfPage":{"@type":"WebPage","@id":"https://zeeshankhan.github.io/posts/core-data-migration/"},"url":"https://zeeshankhan.github.io/posts/core-data-migration/"}</script><title>Core Data Migration | zeeshan's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zeeshan's blog"><meta name="application-name" content="zeeshan's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sample/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zeeshan's blog</a></div><div class="site-subtitle font-italic">Recording my learnings from ï£¿ development</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/zeeshankhan" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/zeeshan_khan" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['izeeshankhan','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Core Data Migration</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Core Data Migration</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1415563200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2014-11-10 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2686 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h2 id="core-data"><span class="mr-2"><strong>Core Data</strong></span><a href="#core-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>A framework which manages, where data is stored, how it is stored, data caching, and memory management.Â It provides APIs to handle our data like insertion, update, deletion and for data validation.Â Basically these core data APIs takes care of all data management rules of sqlite.</p><p><strong>When did it come?</strong> It was ported to the iPhone from Mac OS X with the 3.0 iPhone SDK release.</p><h3 id="why-core-data"><span class="mr-2"><strong>Why Core Data?</strong></span><a href="#why-core-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Why we might want to use Core Data with SQLite for storage over property lists, a custom XML format, or direct SQLite database access? Here we have some reasons:</p><ol><li>It allows developers to create and use a database, perform queries using SQL-less conditions (without SQLite).<li>We interact with SQLite in Objective-C or in objects way. And we donâ€™t have to worry about connections or managing the database schema. Itâ€™s basically a fully object-oriented API, to store data in a database. So we can say, Object oriented database on top of SQL database.<li>The main benefit to this approach is that it reduces the development time and simplifies the process. It can reduce the memory overhead of our app, increase responsiveness, and save us from writing a lot of boilerplate code. Otherwise writing complex SQL queries and handling SQLite operations are very difficult.</ol><h3 id="how-does-it-work"><span class="mr-2"><strong>How does it work?</strong></span><a href="#how-does-it-work" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>There is a tool in Xcode, which we use for creating a visual mapping between the objects (actually NSManagedObject Subclasses) that we are gonna stored in our database, and then Core Data manages all the interaction in between.</p><p>Once we have this visual mapping created in Xcode then we can create new objects, put them in the database, query for objects in the database which is having an SQL database behind it. Core Data manages all the communication behind the scenes, all we see is Object Oriented side of it.</p><h2 id="core-data-terms"><span class="mr-2"><strong>Core Data Terms</strong></span><a href="#core-data-terms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong><a href="https://izeeshan.files.wordpress.com/2014/11/coredataterms.png"><img data-src="https://izeeshan.files.wordpress.com/2014/11/coredataterms.png?w=273" alt="CoreDataTerms" data-proofer-ignore></a></strong></p><h3 id="a-model-managed-object-model-xcdatamodeld"><span class="mr-2"><strong>A Model</strong> (Managed Object Model /Â xcdatamodeld)</span><a href="#a-model-managed-object-model-xcdatamodeld" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>A model that has all tables information. Itâ€™s schema or a database schema - a collection of all the tables (Entities, Data Models) that we use in our application. NSManagedObjectModelÂ is a class that contains definitions for each of the table objects (also called â€œEntitiesâ€) that we have in our database. Usually, we use the visual editor (xcdatamodeld) to set up what tables are in the database, what their columns, and how they relate to each other. However, we can do this with code too!</p><h3 id="a-sore-persistent-store--sqlite-file"><span class="mr-2"><strong>A Sore</strong> (Persistent Store)Â - sqlite file</span><a href="#a-sore-persistent-store--sqlite-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>AÂ file or a database file (with .sqlite extension) stored in our applicationâ€™s document directory.</p><h3 id="a-coordinator-persistent-store-coordinator"><span class="mr-2"><strong>A Coordinator</strong> (Persistent Store Coordinator)</span><a href="#a-coordinator-persistent-store-coordinator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>A coordinator, who first associate store (sqlite file) with model, then coordinates (mediate) between store(s) and context(s).</p><p>Itâ€™s a database connection, where we set up the actual names and locations of what databases will be used to store the objects, and any time a managed object context needs to save something it goes through this single coordinator.</p><h3 id="a-contextmanaged-object-context"><span class="mr-2"><strong>A Context</strong>Â (Managed Object Context)</span><a href="#a-contextmanaged-object-context" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The job of a context is to use coordinator to first retrieve model information, then save our data into store. A context without a coordinator is of no use as it cannot access a model except through a coordinator.Â Its primary responsibility is to manage a collection of managed objects.</p><p>We can think of this as a â€œscratch padâ€ for objects that come from the database. Itâ€™s also the most important of the three for us, because weâ€™ll be working with this the most. Basically, whenever we need to get objects, insert objects, or delete objects, we call methods on the managed object context (or at least most of the time!)</p><p>Only a coordinator can access the model. Not context.</p><p>Only a context can access the coordinator. Not Us.</p><p>So, We access context.</p><h2 id="problem--solution"><span class="mr-2"><strong>Problem &amp; Solution</strong></span><a href="#problem--solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The problem is we canâ€™tÂ add / remove / modify any column in any table at runtime. We canâ€™t alter it by anyway once itâ€™s shipped.Â And to do the same we need to create something called Migration. Or we can say, when weÂ change our data model, then we also need to moveÂ the data in existing stores to new version â€” changing the store format is known as migration.</p><h3 id="when-migration-is-required"><span class="mr-2"><strong>When migration is required?</strong></span><a href="#when-migration-is-required" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The easiest answer to this common question is â€œwhen weÂ need to make changes to the data model.â€Â When the Managed Object Model (mom/xcdatamodel) does not match, a migration is REQUIRED (an instance of NSMigrationManager).</p><h3 id="how-does-it-work-1"><span class="mr-2"><strong>How does it work?</strong></span><a href="#how-does-it-work-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The migration process updates data created with a previous version of the Data Model to match the current Data Model.Â Before going into migration process, lets see how core data initialisation works.</p><h3 id="initializing-core-data"><span class="mr-2"><strong>Initializing Core Data</strong></span><a href="#initializing-core-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We initialize our Core Data stack by calling Context (NSManagedObjectContext), and then context initiate the rest of the work.</p><ol><li>Initialises model with momd (compiled xcdatamodeld).<li>Initialises persistent store coordinator with model.<li>Add a store to persistent store coordinator. (Here Core Data checks for versioning.)<li>Allocate the context, then sets the persistent store coordinator to it.</ol><p>When we encounter these steps, Core Data does a few things in-between just prior to adding the store to the coordinator.</p><ol><li>Core Data analyzes the storeâ€™s model version the one which we are passing to add into coordinator.<li>It compares this version to the coordinatorâ€™s configured data model if there is already one configured earlier.<li>If the storeâ€™s model version and the coordinatorâ€™s model version donâ€™t match, then Core Data will perform a migration, when enabled.<li>If migrations arenâ€™t enabled, and the store is incompatible with the model, Core Data will simply not attach the store to the coordinator and specify an error with an appropriate reason code.</ol><h3 id="the-migration-process"><span class="mr-2"><strong>The Migration Process</strong></span><a href="#the-migration-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>To start the migration process, Core Data needs the original data model (ver 1) and the destination model (ver 2).Â It uses these two versions to load or create a mapping model for the migration. ThenÂ It uses mapping model to convert data in ver 1 (in the original store) to data that it can store to ver 2 (in the new or destination store). Once Core Data determines the mapping model, the migration process can start inÂ earnest.</p><p>During migration, Core Data creates two stacks, one for the source store and one for the destination store. Core Data then fetches objects from the source stack and inserts the appropriate corresponding objects into the destination stack.</p><p>Basically, Migrations happen in three steps:Â First, Core Data copies over all the objects from one data store to the next.Â Next, Core Data connects and relates all the objects according to the relationship mapping.Â Enforce any data validation in the destination model. Core Data disables destination model validation during the data copy.</p><h3 id="changes-that-do-not-require-migration"><span class="mr-2"><strong>Changes that do not require Migration:</strong></span><a href="#changes-that-do-not-require-migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Basically anything that doesnâ€™t change the underlying SQLite backing store, including:</p><ol><li>Changing the name of an NSManagedObject subclass<li>Adding or removing a transient property<li>Making changes to the user info dictionary<li>Changing validation rules.</ol><h3 id="requirements-for-the-migration-process"><span class="mr-2"><strong>Requirements for the Migration Process:</strong></span><a href="#requirements-for-the-migration-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Migration of a persistent store is performed by an instance ofÂ NSMigrationManager. To migrate a store, the migration manager requires several things:</p><ol><li>The managed object model for the destination store. (This is the persistent store coordinatorâ€™s model.)<li>A managed object model that it can use to open the existing store.<li>Typically, a mapping model that defines a transformation from the source (the storeâ€™s) model to the destination model.</ol><p>You donâ€™t need a mapping model if youâ€™re able to use lightweight migration.</p><h2 id="core-data-migration-ways"><span class="mr-2"><strong>Core Data Migration Ways</strong></span><a href="#core-data-migration-ways" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="primary-ways-to-create-a-migration"><span class="mr-2"><strong>Primary ways to create a migration</strong>:</span><a href="#primary-ways-to-create-a-migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Automatic (aka lightweight),<li>Manual, and<li>Custom code.</ul><p>But in reality, the migration process may involve one or more of these techniques.</p><p>The golden rule when it comes to Core Data migrations is, choose lightweight whenever possible. Manual migrations and migrations requiring custom code are a magnitude more complex and memory intensive.</p><h5 id="note--core-data-does-not-perform-migration-linearly-itll-update-the-app-with-whatever-available-like-ver-1-to-ver-3"><span class="mr-2"><strong>NOTE</strong>Â - Core Data does not perform migration linearly. Itâ€™ll update the app with whatever available like ver 1 to ver 3.</span><a href="#note--core-data-does-not-perform-migration-linearly-itll-update-the-app-with-whatever-available-like-ver-1-to-ver-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><h3 id="types-of-migrations"><span class="mr-2"><strong>Types of Migrations:</strong></span><a href="#types-of-migrations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>These are not official categories of migration.</p><ol><li>Lightweight migrations<li>Manual migrations<li>Custom manual migrations<li>Fully manual migrations</ol><p><strong>Lightweight migrations:</strong> A lightweight migration is Appleâ€™s term for the migration with the least amount of work involved on your part.Â If you just make simple changes to your model (such as adding a new attribute to an entity), Core Data can perform automatic data migration, referred to as lightweight migration.</p><p>Lightweight migration is fundamentally the same as ordinary migration, except that instead of you providing a mapping model, Core Data infers one from differences between the source and destination managed object models.</p><p><strong>Manual migrations:</strong>Â Manual migrations involve a little more work on our part. We need to specify how to map the old set of data onto the new set, but we get the benefit of an explicit mapping model file to configure. Setting up a mapping model in Xcode is much like setting up a data model, with similar GUI tools and some automation.</p><p><strong>Custom manual migrations:</strong> If the transformation (add/remove properties or entities to your existing model) is more complex, however, you might need to create a subclass of NSEntityMigrationPolicy to perform the transformation.</p><p>This is level 3 of the migration complexity index. You still use a mapping model, but add to that custom code with the ability to also specify custom transformation logic on data. In this case, custom entity transformation logic involves creating an NSEntityMigrationPolicy subclass and performing custom transformations there.</p><p><strong>Fully manual migrations:</strong>Â Fully manual migrations are for those times when even specifying custom transformation logic isnâ€™t enough to fully migrate data from one model version to another. In this case, custom version detection logic and custom handling of the migration process are necessary.</p><h2 id="lightweight-migration"><span class="mr-2"><strong>Lightweight Migration</strong></span><a href="#lightweight-migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="what-lightweight-migration-can-do"><span class="mr-2"><strong>What lightweight migration can do.</strong></span><a href="#what-lightweight-migration-can-do" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Lightweight migrations can handle the following changes:</p><ol><li>Adding or removing an entity, attribute, or relationship<li>Making an attribute non-optional with a default value<li>Making a non-optional attribute optional<li>Renaming an entity or attribute using a renaming identifier</ol><h3 id="enable-lightweight-migrations-"><span class="mr-2"><strong>Enable Lightweight Migrations</strong>Â -</span><a href="#enable-lightweight-migrations-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>You need to pass a dictionary containing two keys to theÂ <strong>options</strong>Â parameter of the method that adds the persistent store to the coordinator. These keys are:</p><ul><li>NSMigratePersistentStoresAutomaticallyOption â€“ attempt to automatically migrate versioned stores<li>NSInferMappingModelAutomaticallyOption â€“ attempt to create the mapping model automatically</ul><h3 id="steps-"><span class="mr-2"><strong>Steps</strong>Â -</span><a href="#steps-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Open your .xcdatamodeld file<li>Click on Editor in Menu Bar<li>Select Add Model Versionâ€¦.<li>Add a new version of your model (the new group of datamodels added)<li>Select the main file, open File Inspector (Right-Hand Panel)<li>And under Model Version core data modelÂ select your new version of data model for current data model from drop down.<li>Thatâ€™s not all, WeÂ need to perform so-called â€œlight migrationâ€ with code.<li>Go to your Core Data stack manager and find where theÂ persistentStoreCoordinatorÂ is being created.<li>Find this lineÂ if (![_persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error])<li>ReplaceÂ nilÂ options value withÂ @{NSMigratePersistentStoresAutomaticallyOption:@YES, NSInferMappingModelAutomaticallyOption:@YES}Â (actually provided in the commented code in that method)</ol><p>Here you go, have fun!</p><h2 id="manual-migration"><span class="mr-2"><strong>Manual Migration</strong></span><a href="#manual-migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you want to make a change to the new model thatâ€™s not supported by lightweight migrations, you need to create a mapping model.Â A mapping model needs a source and a destination data model.Â When you add a new version of your data model, you are asked to select the model on which it should be based.</p><h3 id="adding-a-version-to-data-models"><span class="mr-2"><strong>Adding a version to data models:</strong></span><a href="#adding-a-version-to-data-models" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Open your .xcdatamodeld file<li>Click on Editor in Menu Bar<li>Select Add Model Versionâ€¦.<li>Add a new version of your model (the new group of datamodels added)<li>Select the main file, open File Inspector (Right-Hand Panel)<li>And under Model Version core data modelÂ select your new version of data model for current data model from drop down.<li>Make the desired changes in Newly created Data Models (xcdatamodel file).</ol><h3 id="adding-a-mapping-model-for-versions"><span class="mr-2"><strong>Adding a mapping model for versions:</strong></span><a href="#adding-a-mapping-model-for-versions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Select New, Fileâ€¦ from File menu on menu bar.<li>Select Core Data from left panel and Mapping Model from right options then click Next.<li>Select Source Data Model (Version 1) from list of xcdatamodel files then click Next.<li>Choose Target Data Model (Destination or Next Version) from same list of xcdatamodel files then click Next.</ol><h3 id="now-lets-perform-manual-migration-with-code"><span class="mr-2"><strong>Now, letâ€™s perform Manual Migration with Code</strong></span><a href="#now-lets-perform-manual-migration-with-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Go to yourÂ Core Data stack manager and find where theÂ persistentStoreCoordinatorÂ is being created.<li>Find this lineÂ if (![_persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error])<li>ReplaceÂ nilÂ options value with @{NSInferMappingModelAutomaticallyOption:@YES}.</ol><p><strong>Is migration needed?</strong> Migration is needed if destinationModel is NOT compatible with store meta data. Letâ€™s check the same.</p><ul><li>Get metadata for source store from its url with given type (NSSQLiteStoreType).<li>Get the destination managed object model from xcdatamodeld url.<li>Call â€˜compatible with store meta dataâ€™ function on destination managed object model. It returns bool value.<li>We need migration if above function returns false.</ul><p>- (BOOL)isMigrationNeeded { NSError *error = nil; NSDictionary *sourceMetadata = [NSPersistentStoreCoordinator metadataForPersistentStoreOfType:NSSQLiteStoreType URL:[self sourceStoreURL] error:&amp;error]; BOOL isMigrationNeeded = NO; if (sourceMetadata != nil) { NSManagedObjectModel *destinationModel = [self managedObjectModel]; // Migration is needed if destinationModel is NOT compatible isMigrationNeeded = ![destinationModel isConfiguration:nil compatibleWithStoreMetadata:sourceMetadata]; } Â  NSLog(@â€isMigrationNeeded: %@â€, (isMigrationNeeded == YES) ? @â€YESâ€ : @â€NOâ€); return isMigrationNeeded; }</p><h3 id="the-migration-method"><span class="mr-2"><strong>The Migration Method</strong></span><a href="#the-migration-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>Get metadata for source store from its url with given type (NSSQLiteStoreType).<li>Create managed object model from source meta data.<li>Get the destination managed object model from xcdatamodeld url.<li>Get Mapping Model from bundle with source and destination managed object model.<li>Create a destination store url (a different sqlite file path).<li>Initialise a Migration Manager with source and destination managed object model.<li>Now,Â NSMigrationManager can infer the mapping model between two models. So, call a migrate store function on manager with mapping model from source store url to destination store url.<li>Remove old store file(s) (shm or wal) and then copy the destination store url to old source store location.</ol><p>- (BOOL)migrate {</p><p>Â  Â  NSURL *sourceUrl = [self sourceStoreURL]; // 1. Get metadata for source store from its URL with given type. Â  Â  NSError *error = nil; NSDictionary *sourceMetadata = [NSPersistentStoreCoordinator metadataForPersistentStoreOfType:NSSQLiteStoreType URL:sourceUrl error:&amp;error]; Â  Â  if (sourceMetadata == NO) { NSLog(@â€FAILED to create source meta dataâ€); Â  Â  Â  Â  return NO; Â  Â  }</p><p>// 2. Create model from source store meta deta. NSManagedObjectModel *sourceModel = [NSManagedObjectModel mergedModelFromBundles:@[[NSBundle mainBundle]] forStoreMetadata:sourceMetadata]; Â  Â  if (sourceModel == nil) { NSLog(@â€FAILED to create source model, something wrong with source xcdatamodel.â€); Â  Â  Â  Â  return NO; Â  Â  }</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>// 3. Get the destination managed object model from xcdatamodeld url. Â  Â  NSManagedObjectModel \*destinationModel = \[self managedObjectModel\];

// 4. Get Mapping model from bundle with source and destination managed object model.  NSMappingModel \*mappingModel = \[NSMappingModel mappingModelFromBundles:@\[\[NSBundle mainBundle\]\] forSourceModel:sourceModel destinationModel:destinationModel\];
</pre></table></code></div></div><p>// 5. Create the destination store url (a different sqlite/database file path) NSString *fileName = @â€ZKManualMigration_V2.sqliteâ€; NSURL *destinationStoreURL =Â  [[[[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask] lastObject] URLByAppendingPathComponent:fileName]; // 6. Migrate from source to latest matched destination model, Â  Â  NSMigrationManager *manager = [[NSMigrationManager alloc] initWithSourceModel:sourceModel destinationModel:destinationModel]; Â  Â  BOOL didMigrate = [manager migrateStoreFromURL:sourceUrlÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type:NSSQLiteStoreTypeÂ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  options:nil Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  withMappingModel:mappingModelÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toDestinationURL:destinationStoreURLÂ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destinationType:NSSQLiteStoreTypeÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destinationOptions:nilÂ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  error:&amp;error]; Â  Â  if (!didMigrate) { Â  Â  Â  Â  return NO; Â  Â  } Â  Â  NSLog(@â€Migrating from source: %@ ===To=== %@â€, sourceUrl.path, destinationStoreURL.path); // 7. Delete old sqlite file Â  Â  NSError *err = nil; NSFileManager *fm = [NSFileManager defaultManager]; Â  Â  if (![fm removeItemAtURL:sourceUrl error:&amp;err]) { NSLog(@â€File delete failed.â€); Â  Â  Â  Â  return NO; Â  Â  } Â  Â  NSString *str1 = [NSString stringWithFormat:@â€%@-shmâ€,sourceUrl.path]; [fm removeItemAtURL:[NSURL fileURLWithPath:str1] error:&amp;err]; Â  Â  str1 = [NSString stringWithFormat:@â€%@-walâ€,sourceUrl.path]; [fm removeItemAtURL:[NSURL fileURLWithPath:str1] error:&amp;err]; // Copy into new location Â  Â  if (![fm moveItemAtURL:destinationStoreURL toURL:sourceUrl error:&amp;err]) { NSLog(@â€File move failed.â€); Â  Â  Â  Â  return NO; Â  Â  }</p><p>NSLog(@â€Migration successfulâ€); Â  Â  return didMigrate; }</p><h5 id="sample-project-on-manual-migration"><span class="mr-2">Â <a href="https://github.com/zeeshankhan/ZKManualMigration" title="Sample project"><span class="mr-2">Sample project</a> on Manual Migration.</span><a href="#sample-project-on-manual-migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5></h5><p>Thanks for reading, cheersâ€¦ ğŸ‘</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/core-data/" class="post-tag no-text-decoration" >core-data</a> <a href="/tags/example-code/" class="post-tag no-text-decoration" >example-code</a> <a href="/tags/frameworks/" class="post-tag no-text-decoration" >frameworks</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-library/" class="post-tag no-text-decoration" >ios-library</a> <a href="/tags/iphone/" class="post-tag no-text-decoration" >iphone</a> <a href="/tags/migration/" class="post-tag no-text-decoration" >migration</a> <a href="/tags/sqlite/" class="post-tag no-text-decoration" >sqlite</a> <a href="/tags/xcode/" class="post-tag no-text-decoration" >xcode</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Core Data Migration - zeeshan&#39;s blog&amp;url=https://zeeshankhan.github.io/posts/core-data-migration/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Core Data Migration - zeeshan&#39;s blog&amp;u=https://zeeshankhan.github.io/posts/core-data-migration/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://zeeshankhan.github.io/posts/core-data-migration/&amp;text=Core Data Migration - zeeshan&#39;s blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/view/">iOS View</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/blocks/"><div class="card-body"> <em class="timeago small" data-ts="1346184000" > 2012-08-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Blocks</h3><div class="text-muted small"><p> Blocks are an extension to the C language and thus fully supported in Objective-C. There are two ways to use block: The most common way to use a block is to pass it to a method that in turn ca...</p></div></div></a></div><div class="card"> <a href="/posts/open-source-libraries-for-ios/"><div class="card-body"> <em class="timeago small" data-ts="1328040000" > 2012-02-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Open source libraries for iOS</h3><div class="text-muted small"><p> I have found some useful iOS libraries. Three20 : Framework developed by Facebook for their iPhone App. MBProgressHUD : To display a progress activity window. DSActivityView: To display a p...</p></div></div></a></div><div class="card"> <a href="/posts/hidden-features-of-xcode-4/"><div class="card-body"> <em class="timeago small" data-ts="1327953600" > 2012-01-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hidden Features of Xcode 4</h3><div class="text-muted small"><p> Hi All, I was exploring Xcode 4 features and i found some pretty stuff to share. Below is the list of Xcode features which may help you with writing Cocoa/Cocoa touch code. You can find the discuss...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/dispatch-barriers/" class="btn btn-outline-primary" prompt="Older"><p>Handling Shared Resources using Dispatch Barriers</p></a> <a href="/posts/custom-nslog/" class="btn btn-outline-primary" prompt="Newer"><p>Custom NSLog</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> Â© 2024 <a href="https://twitter.com/zeeshan_khan">Zeeshan Khan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/swift/">swift</a> <a class="post-tag" href="/tags/objective-c/">objective-c</a> <a class="post-tag" href="/tags/multithreading/">multithreading</a> <a class="post-tag" href="/tags/threads/">threads</a> <a class="post-tag" href="/tags/blocks/">blocks</a> <a class="post-tag" href="/tags/gcd/">gcd</a> <a class="post-tag" href="/tags/ipad/">ipad</a> <a class="post-tag" href="/tags/nsthread/">nsthread</a> <a class="post-tag" href="/tags/view-controllers/">view-controllers</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
